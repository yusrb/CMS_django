{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
{% include 'snippets/nav.html' %}
<div class="container-fluid mt-5 pt-3">
    <div class="container">
        <div class="row">
            <!-- Komunitas Detail Start -->
            <div class="w-[66.6%]">
                <!-- Header Section -->
                <div class="section-title mb-3 text-center skew-x-2">
                    <h4 class="m-0 text-uppercase font-weight-bold">{{komunitas.nama}}</h4>
                    <a class="text-secondary font-weight-medium text-decoration-none"
                        href="{% url 'user:komunitas_list' %}">Kembali ke Home</a>
                </div>

                <!-- Modal Error -->
                {% if messages %}
                    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content rounded-lg shadow-xl">
                                <div class="modal-header bg-warning text-black border-0">
                                    <h5 class="modal-title" id="errorModalLabel">Pesan Error</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body bg-white text-black py-4">
                                    {% for message in messages %}
                                        <p>{{ message }}</p>
                                    {% endfor %}
                                </div>
                                <div class="modal-footer bg-white border-0">
                                    <button type="button" class="btn btn-warning text-black" data-bs-dismiss="modal">Tutup</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            {% if komunitas.foto_komunitas and komunitas.foto_komunitas.url %}
                            <img src="{{ komunitas.foto_komunitas.url }}" class="img-fluid w-full rounded shadow-md"
                                alt="Komunitas Image" style="height: 350px; object-fit: cover;">
                            {% else %}
                            <img src="https://via.placeholder.com/1200x400" class="img-fluid rounded shadow-md"
                                alt="Komunitas Image" style="height: 350px; object-fit: cover;">
                            {% endif %}
                        </div>
                        <p class="text-left mt-3 text-muted">
                            {{ komunitas.deskripsi|truncatewords:40 }}
                        </p>
                    </div>
                </div>

                <!-- Pertanyaan Section -->
                <div class="card shadow-sm mb-4" id="pertanyaan-list">
                    <div class="card-header bg-primary text-white">
                        <h5 class="font-weight-bold m-0"><i class="fas fa-question-circle"></i> Diskusi Komunitas
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if pertanyaan_list %}
                        <div class="list-group">
                            {% for pertanyaan in pertanyaan_list %}
                            <div class="list-group-item position-relative" id="pertanyaan-{{ pertanyaan.id }}">
                                {% if pertanyaan.penulis == user or request.user.level == 'Admin' %}
                                <div class="position-absolute top-0 end-0 mt-2 me-2">
                                    <div class="dropdown d-inline-block">
                                        <button class="btn btn-sm" type="button"
                                            id="dropdownMenuButton-{{ pertanyaan.id }}" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            <i class="fas fa-ellipsis-v font-weight-bold"></i>
                                        </button>
                                        <ul class="dropdown-menu"
                                            aria-labelledby="dropdownMenuButton-{{ pertanyaan.id }}">
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="showUpdatePertanyaanForm({{ pertanyaan.id }})">Update</a>
                                            </li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="confirmDeletePertanyaan({{ pertanyaan.id }})">Delete</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <form id="delete-form-{{ pertanyaan.id }}" method="post"
                                        action="{% url 'user:pertanyaan_komunitas_delete' pertanyaan_id=pertanyaan.id %}"
                                        style="display:none;">
                                        {% csrf_token %}
                                        <input type="hidden" name="pertanyaan_id" value="{{ pertanyaan.id }}">
                                        <button type="submit"></button>
                                    </form>
                                </div>
                                {% endif %}
                                <h6 class="font-weight-bold mt-1">{{ pertanyaan.judul }}</h6>
                                <p class="text-muted">{{ pertanyaan.isi|truncatewords:30 }}</p>
                                <small class="text-muted d-block">
                                    <i class="fas fa-user"></i> Ditanyakan oleh {{ pertanyaan.penulis }}
                                    <i class="fas fa-clock ml-2"></i> {{ pertanyaan.created_at|timesince }}
                                </small>

                                <!-- Lihat Jawaban -->
                                <button class="btn btn-warning btn-sm mt-3" data-bs-toggle="modal"
                                    data-bs-target="#jawabanModal-{{ pertanyaan.id }}">Lihat Jawaban</button>

                                <!-- Modal Jawaban -->
                                <div class="modal fade" id="jawabanModal-{{ pertanyaan.id }}" tabindex="-1"
                                aria-labelledby="jawabanModalLabel-{{ pertanyaan.id }}" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered modal-lg rounded">
                                    <div class="modal-content bg-light border-0 rounded">
                                        <div class="modal-header bg-warning text-dark">
                                            <h5 class="modal-title" id="jawabanModalLabel-{{ pertanyaan.id }}">
                                                Jawaban untuk: {{ pertanyaan.judul }}
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>

                                        <!-- Modal Body -->
                                        <div class="modal-body">
                                            <!-- Pertanyaan -->
                                            <div class="mb-4">
                                                <h4 class="text-dark fw-bold mb-2">{{ pertanyaan.judul }}</h4>
                                                <p class="text-dark mb-2">{{ pertanyaan.isi }}</p>
                                                <p class="text-muted small d-flex align-items-center">
                                                    <i class="fas fa-user me-2"></i>
                                                    <span>Ditanyakan oleh: <strong>{{ pertanyaan.penulis.username }}</strong></span>
                                                    <i class="fas fa-clock ms-3 me-2"></i>
                                                    <span>{{ pertanyaan.created_at|timesince }} yang lalu</span>
                                                </p>
                                            </div>

                                            <hr class="my-3">

                                            <!-- Jawaban Section -->
                                            <h5 class="font-bold text-xl text-center mb-3">Jawaban</h5>
                                            <div id="jawaban-list-{{ pertanyaan.id }}" class="mb-4">
                                                {% for jawaban in pertanyaan.jawaban_set.all %}
                                                <div class="alert bg-white border p-3 mb-3 rounded position-relative shadow-sm">
                                                    <!-- Opsi untuk Pengguna -->
                                                    {% if jawaban.penulis == user %}
                                                    <div class="position-absolute top-0 end-0 mt-2 me-2">
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm text-dark" type="button"
                                                                id="dropdownMenuButtonJawaban-{{ jawaban.id }}" data-bs-toggle="dropdown"
                                                                aria-expanded="false">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButtonJawaban-{{ jawaban.id }}">
                                                                <li><a class="dropdown-item text-danger" href="#"
                                                                        onclick="confirmDeleteJawaban({{ jawaban.id }})">Hapus</a></li>
                                                                <li><a class="dropdown-item" href="#"
                                                                        data-bs-toggle="modal" data-bs-target="#updateJawabanModal-{{ jawaban.id }}">Edit</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    <!-- Isi Jawaban -->
                                                    <strong class="text-dark small d-block mb-1">{{ jawaban.penulis.username }}</strong>
                                                    <small class="text-muted">{{ jawaban.created_at|timesince }} yang lalu</small>
                                                    <p class="text-dark mt-2">{{ jawaban.isi }}</p>
                                                </div>

                                                <!-- Form Hapus Jawaban -->
                                                <form id="delete-form-jawaban-{{ jawaban.id }}" method="post"
                                                    action="{% url 'user:jawab_pertanyaan_delete' pertanyaan_id=pertanyaan.id jawaban_id=jawaban.id %}"
                                                    style="display:none;">
                                                    {% csrf_token %}
                                                    <button type="submit"></button>
                                                </form>
                                                {% endfor %}
                                            </div>

                                            <!-- Form Tambah Jawaban -->
                                            <form action="{% url 'user:jawab_pertanyaan' pertanyaan_id=pertanyaan.id %}" method="post">
                                                {% csrf_token %}
                                                <div class="form-group mb-3">
                                                    <label for="jawaban-{{ pertanyaan.id }}" class="form-label font-bold text-gray-800">Jawaban Anda</label>
                                                    <textarea name="isi" class="form-control" rows="3" placeholder="Tulis jawaban Anda di sini..." required></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-warning btn-sm">Kirim Jawaban</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                </div>

                                <!-- Modal Update Jawaban -->
                                {% for jawaban in pertanyaan.jawaban_set.all %}
                                <div class="modal fade" id="updateJawabanModal-{{ jawaban.id }}" tabindex="-1"
                                    aria-labelledby="updateJawabanModalLabel-{{ jawaban.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg rounded">
                                        <div class="modal-content bg-light border-0 rounded">
                                            <div class="modal-header bg-warning text-dark">
                                                <h5 class="modal-title" id="updateJawabanModalLabel-{{ jawaban.id }}">
                                                    Update Jawaban untuk: {{ jawaban.pertanyaan.judul }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form action="{% url 'user:jawab_pertanyaan_update' pertanyaan_id=pertanyaan.id jawaban_id=jawaban.id %}" method="post">
                                                    {% csrf_token %}
                                                    <div class="form-group">
                                                        <label for="jawaban-{{ jawaban.id }}">Jawaban Anda</label>
                                                        <textarea name="isi" class="form-control" rows="3" required>{{ jawaban.isi }}</textarea>
                                                    </div>
                                                    <button type="submit" class="btn btn-warning btn-sm mt-3">Update Jawaban</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <div id="jawaban-result-{{ pertanyaan.id }}" class="mt-3"></div>

                                <!-- form Update Pertanyaan -->
                                <div id="update-form-{{ pertanyaan.id }}" class="update-form mt-3"
                                    style="display:none;">
                                    <form
                                        action="{% url 'user:pertanyaan_komunitas_update' pertanyaan_id=pertanyaan.id %}"
                                        method="post">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <label for="judul">Judul Pertanyaan</label>
                                            <input type="text" name="judul" class="form-control"
                                                value="{{ pertanyaan.judul }}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="isi">Isi Pertanyaan</label>
                                            <textarea name="isi" class="form-control" rows="3"
                                                required>{{ pertanyaan.isi }}</textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm">Simpan</button>
                                        <button type="button" class="btn btn-danger btn-sm"
                                            onclick="hideUpdatePertanyaanForm({{ pertanyaan.id }})">Batal</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Belum ada pertanyaan di komunitas ini.</p>
                        {% endif %}
                    </div>

                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-white">
                        <h5 class="font-weight-bold m-0"><i class="fas fa-plus-circle"></i> Buat Pertanyaan Baru</h5>
                    </div>
                    <div class="card-body">
                        <form action="{% url 'user:pertanyaan_komunitas_create' komunitas_id=komunitas.id %}"
                            method="post">
                            {% csrf_token %}
                            {{ form|crispy }}
                            <button type="submit"
                                class="w-full py-2 bg-yellow-400 text-white rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all">
                                Kirim Pertanyaan
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Komunitas Detail End -->

            <!-- Sidebar -->
            <div class="w-[30.3%] left-2 relative">
                <div class="card shadow-lg rounded-lg border border-z-300">
                    <div class="card-header bg-warning text-white">
                        <h5 class="font-semibold text-xl relative top-1">Informasi Komunitas</h5>
                    </div>
                    <div class="card-body text-sm">
                        <ul class="space-y-2">
                            <li><strong>Pembuat:</strong> {{ komunitas.user.username }}</li>
                            <li><strong>Dibuat pada:</strong> {{ komunitas.tanggal|date:"d, M Y" }}</li>
                            <li><strong>Pengguna Online:</strong> {{ users_online }}</li>
                        </ul>

                        <hr class="relative">

                        {% if user in komunitas.members.all %}
                        <button class="btn btn-yellow-500 w-full text-sm font-semibold mt-4" disabled>Anda Sudah
                            Bergabung</button>
                        <button class="px-3 py-3 rounded text-white bg-red-500 w-full text-sm font-semibold mt-1" data-bs-toggle="modal"
                            data-bs-target="#confirmLeaveModal">
                            Keluar dari Komunitas
                        </button>

                        <!-- Modal Confirm Keluar -->
                        <div class="modal fade" id="confirmLeaveModal" tabindex="-1"
                            aria-labelledby="confirmLeaveModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-warning">
                                        <h5 class="modal-title" id="confirmLeaveModalLabel">Konfirmasi Keluar</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Apakah Anda yakin ingin keluar dari komunitas {{ komunitas.nama }}?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Batal</button>
                                        <form method="post" action="{% url 'user:komunitas_keluar' komunitas.pk %}"
                                            class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger">Ya, Keluar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% else %}
                        <form method="post" action="{% url 'user:komunitas_join' komunitas.pk %}" class="mt-4">
                            {% csrf_token %}
                            <button type="submit"
                                class="px-3 py-3 relative bottom-1 bg-gradient-to-br from-[#FBC02D] to-[#FF9800] w-full rounded-md text-sm text-white font-semibold transition-all duration-300 hover:from-[#FFEB3B] hover:to-[#FFC107] focus:outline-none focus:ring-2 focus:ring-[#FF7043] shadow-2xl hover:shadow-2xl">
                                Bergabung dengan Komunitas
                            </button>
                        </form>
                        {% endif %}

                    </div>
                    </div>

                    <div class="card mt-6">
                        <div class="card-header bg-warning text-white">
                            <h5 class="font-semibold text-xl relative top-1">Bookmarks Komunitas</h5>
                        </div>
                    <div class="card-body">
                        <ul class="space-y-2">
                            {% for bookmark in bookmarks %}
                            <li>
                                <a href="{{ bookmark.url_link }}" target="_blank"
                                    class="text-lg font-extrabold text-gray-600 hover:text-gray-800">
                                    {{ bookmark.judul }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <div class="card mt-6">
                    <div class="card-header bg-warning text-white">
                        <h5 class="font-semibold text-xl relative top-1">Peraturan Komunitas</h5>
                    </div>
                    <div class="card-body text-sm">
                        <ul class="space-y-2">
                            {% for peraturan in peraturans %}
                            <li>
                                <button
                                    class="text-left w-full font-bold text-gray-600 hover:text-gray-800 flex items-center justify-between"
                                    onclick="toggleDescription('{{ peraturan.id }}')">
                                    <span>{{ peraturan.judul }}</span>
                                    <i id="arrow-{{ peraturan.id }}" class="fas fa-chevron-down"></i>
                                </button>

                                <div id="desc-{{ peraturan.id }}" class="text-[11.8px] text-gray-600 hidden mt-2">
                                    {{ peraturan.deskripsi }}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Sidebar End -->



        </div>
    </div>
</div>

<script>
    function showUpdatePertanyaanForm(pertanyaanId) {
        var currentForm = document.querySelector('.update-form[style="display: block;"]');
        if (currentForm) {
            var currentPertanyaanId = currentForm.id.replace('update-form-', '');
            var currentDropdownButton = document.getElementById('dropdownMenuButton-' + currentPertanyaanId);
            if (currentDropdownButton) {
                currentDropdownButton.style.display = 'block';
            }

            setTimeout(function () {
                currentForm.style.display = 'none';
            }, 100);
        }

        var dropdownButton = document.getElementById('dropdownMenuButton-' + pertanyaanId);
        if (dropdownButton) {
            dropdownButton.style.display = 'none';
        }

        var formElement = document.getElementById('update-form-' + pertanyaanId);
        var pertanyaanElement = document.getElementById('pertanyaan-' + pertanyaanId);

        formElement.style.display = 'block';

        setTimeout(function () {
            pertanyaanElement.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 150);
    }

    function hideUpdatePertanyaanForm(pertanyaanId) {
        var dropdownButton = document.getElementById('dropdownMenuButton-' + pertanyaanId);
        if (dropdownButton) {
            dropdownButton.style.display = 'block';
        }

        var formElement = document.getElementById('update-form-' + pertanyaanId);
        if (formElement) {
            formElement.style.display = 'none';
        }
    }

    function confirmDeletePertanyaan(pertanyaanId) {
        if (confirm('Apakah Anda yakin ingin menghapus pertanyaan ini?')) {
            document.getElementById('delete-form-' + pertanyaanId).submit();
        }
    }

    function confirmDeleteJawaban(jawabanId) {
        var form = document.getElementById('delete-form-jawaban-' + jawabanId);
        if (confirm('Apakah Anda yakin ingin menghapus jawaban ini?')) {
            form.submit();
        }
    }


    function showDeleteJawabanConfirm(jawabanId) {
        if (confirm('Apakah Anda yakin ingin menghapus jawaban ini?')) {
            var form = document.getElementById('delete-form-jawaban-' + jawabanId);
            form.submit();
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const scrollTo = urlParams.get('scroll_to');
    if (scrollTo) {
        scrollToElementById(scrollTo);
    }

    window.onload = function () {
        if (window.location.hash) {
            var targetElement = document.querySelector(window.location.hash);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }
    };

    function scrollToElementById(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }

    function toggleDescription(id) {
        var descElement = document.getElementById('desc-' + id);
        var arrowElement = document.getElementById('arrow-' + id);

        if (descElement.classList.contains('hidden')) {
            descElement.classList.remove('hidden');
            arrowElement.classList.remove('fa-chevron-down');
            arrowElement.classList.add('fa-chevron-up');
        } else {
            descElement.classList.add('hidden');
            arrowElement.classList.remove('fa-chevron-up');
            arrowElement.classList.add('fa-chevron-down');
        }
    }

    {% if messages %}
            var myModal = new bootstrap.Modal(document.getElementById('errorModal'), {});
            myModal.show();
        {% endif %}
</script>


{% endblock content %}
